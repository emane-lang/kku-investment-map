<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- âœ… Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ÙŠÙ† Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ -->
  <title>Ø§Ù„Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ù„Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family: Tahoma, Arial, sans-serif;
      background:#f5f5f5; color:#333;
      height:100vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    /* âœ… ÙŠØ®Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨Ø¯Ù‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± */
    .container{
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    /* ====== HEADER (Ù†ÙØ³ ØªØµÙ…ÙŠÙ…Ùƒ) ====== */
    .header{
      background: linear-gradient(135deg, #1a5f3f 0%, #a5b9b0 100%);
      color:#fff;
      padding:18px 20px;
      text-align:center;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:20px;
      flex-shrink:0;
    }
    .logo{ width:90px; height:90px; display:flex; align-items:center; justify-content:center; }
    .logo img{ width:100%; height:100%; object-fit:contain; background:#e4f3ec; border-radius:15px; }
    .header-content h1{ font-size:28px; font-weight:bold; margin:0; }
    .header-content p{ font-size:14px; margin-top:5px; opacity:.9; }

    /* âœ… Ø£Ù‡Ù… Ø³Ø·Ø±ÙŠÙ† Ù„ØªÙ…Ø¯Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    .content{
      flex:1;
      display:flex;
      overflow:hidden;
      min-height:0;
    }

.sidebar{
      width:380px;
      background:#fff;
      border-left:1px solid #ddd;
      overflow-y:auto;
      padding:20px;
      box-shadow:-2px 0 8px rgba(0,0,0,.1);
      display:flex; flex-direction:column;
    }
    .sidebar h2{
      color:#1a5f3f;
      font-size:18px;
      margin-bottom:15px;
      border-bottom:2px solid #2d8659;
      padding-bottom:10px;
    }


    .filters{
      background:#f9f9f9;
      border:1px solid #e0e0e0;
      border-radius:6px;
      padding:15px;
      margin-bottom:14px;
    }
    .filter-group{ margin-bottom:12px; }
    .filter-group label{
      display:flex; align-items:center; gap:6px;
      font-size:13px; font-weight:bold; color:#1a5f3f;
      margin-bottom:6px;
    }
    .filter-group select{
      width:100%;
      padding:8px;
      border:1px solid #ddd;
      border-radius:4px;
      font-size:13px;
      font-family: Tahoma, Arial, sans-serif;
      background:#fff;
      cursor:pointer;
    }
    .filter-group select:focus{ outline:none; border-color:#2d8659; }

    /* ====== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ====== */
    .statistics{
      background: linear-gradient(135deg, #1a5f3f 0%, #a5b9b0 100%);
      border-radius:8px;
      padding:14px;
      margin-bottom:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    .statistics h3{
      color:#fff;
      font-size:15px;
      margin-bottom:10px;
      text-align:center;
    }
    .stats-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .stat-item{
      background:#fff;
      border-radius:6px;
      padding:12px;
      text-align:center;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }
    .stat-item .number{ font-size:24px; font-weight:bold; color:#2d8659; display:block; margin-bottom:4px; }
    .stat-item .label{ font-size:12px; color:#666; }

    .sidebar h2{
      color:#1a5f3f;
      font-size:18px;
      margin:12px 0 10px;
      border-bottom:2px solid #2d8659;
      padding-bottom:10px;
    }

 

    .location-item{
      background:#f9f9f9;
      border:1px solid #e0e0e0;
      border-radius:6px;
      padding:12px;
      margin-bottom:12px;
      cursor:pointer;
      transition:all .2s ease;
    }
    .location-item:hover{
      background:#e8f5e9;
      border-color:#2d8659;
      box-shadow:0 2px 6px rgba(45,134,89,.2);
    }
    .location-item h3{
      color:#1a5f3f;
      font-size:16px;
      margin-bottom:10px;
      font-weight:bold;
      border-bottom:1px solid #e0e0e0;
      padding-bottom:5px;
    }
    .location-item p{ font-size:12px; color:#666; margin:4px 0; line-height:1.5; }
    .location-item p strong{ color:#2d8659; }

    .map-container{
      flex:1;
      position:relative;
      overflow:hidden;
      min-height:0; /* Ù…Ù‡Ù… */
    }
    #map{
      width:100%;
      height:100%;
      min-height:100%;
    }

    .leaflet-popup-content{ direction:rtl; text-align:right; font-family:Tahoma, Arial, sans-serif; }
    .leaflet-popup-content h4{
      color:#1a5f3f;
      margin-bottom:10px;
      font-size:15px;
      font-weight:bold;
      border-bottom:1px solid #eee;
      padding-bottom:5px;
    }
    .leaflet-popup-content p{ margin:5px 0; font-size:12px; color:#333; }
    .leaflet-popup-content strong{ color:#2d8659; }

  .legend{
      background:#fff;
      border:1px solid #ddd;
      border-radius:6px;
      padding:12px;
      margin-top:15px;
    }
    .legend h3{ color:#1a5f3f; font-size:13px; margin-bottom:8px; }

    .empty-state{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      height:100%;
      color:#999;
      text-align:center;
      padding:20px;
    }
    .empty-state h3{ color:#666; margin-bottom:10px; }
    .empty-state p{ font-size:13px; margin-bottom:18px; }
    .btn-upload{
      background: linear-gradient(135deg, #1a5f3f 0%, #2d8659 100%);
      color:#fff;
      padding:10px 20px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
      transition:all .2s ease;
    }
    .btn-upload:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(26,95,63,.3); }

    .no-results{ text-align:center; padding:20px; color:#999; font-size:13px; }

    /* ====== FOOTER (Ù†ÙØ³ ØªØµÙ…ÙŠÙ…Ùƒ) ====== */
    .footer{
      flex-shrink:0;
      background:#f0f0f0;
      border-top:1px solid #ddd;
      padding:10px 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:15px;
      font-size:13px;
      color:#555;
    }
    .footer img{ height:40px; object-fit:contain; }
    .footer a{ color:#1a5f3f; text-decoration:none; font-weight:bold; }
    .footer a:hover{ text-decoration:underline; }

    /* âœ… Ø§Ù„Ø¬ÙˆØ§Ù„: Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª+ÙÙ„Ø§ØªØ± Ø«Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŒ Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ø¦Ù…Ø© */
    @media (max-width: 768px){
      body{ height:auto; overflow:auto; }
      .container{ height:auto; overflow:visible; }
      .content{ flex-direction:column; overflow:visible; }

      .header{ flex-direction:column; gap:10px; }
      .header-content h1{ font-size:20px; }

      
      .map-container{ order:2; height:65vh; min-height:380px; }
      #map{ height:100%; min-height:380px; }

      #locationsList{ display:none; }

      .footer{ flex-direction:column; text-align:center; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <img src="logo.svg" alt="Ø´Ø¹Ø§Ø± Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ Ø®Ø§Ù„Ø¯">
      </div>
      <div class="header-content">
        <!-- âœ… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£ÙˆÙ„ -->
        <h1>Ø§Ù„Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ù„Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h1>
        <!-- âœ… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <p>Ø®Ø±ÙŠØ·Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±Ø©</p>
      </div>
    </div>

    <div class="content">
      <div class="map-container">
        <div id="map"></div>
        <div class="empty-state" id="emptyState" style="display:none;">
          <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</h3>
          <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹</p>
          <button class="btn-upload" onclick="window.location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </div>
      </div>

      <div class="sidebar">
        <div class="statistics">
          <h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="number" id="totalLocations">0</span>
              <span class="label">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ</span>
            </div>
            <div class="stat-item">
              <span class="number" id="totalContracts">0</span>
              <span class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯</span>
            </div>
            <div class="stat-item">
              <span class="number" id="totalEnded">0</span>
              <span class="label">Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</span>
            </div>
            <div class="stat-item">
              <span class="number" id="totalActive">0</span>
              <span class="label">Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø³Ø§Ø±ÙŠØ©</span>
            </div>
          </div>
        </div>

        <div class="filters">
          <!-- âœ… ÙÙ„ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ = Ø§Ù„Ø¹Ù…ÙˆØ¯ O (Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±) -->
          <div class="filter-group">
            <label for="filterSource">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
            <select id="filterSource">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option>
            </select>
          </div>

          <!-- âœ… ÙÙ„ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰ = Ø§Ù„Ø¹Ù…ÙˆØ¯ P (Ø§Ù„Ù…Ø¨Ù†Ù‰) -->
          <div class="filter-group">
            <label for="filterBuilding">ğŸ¢ Ø§Ù„Ù…Ø¨Ù†Ù‰:</label>
            <select id="filterBuilding">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>
            </select>
          </div>

          <!-- âœ… ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© = Ø§Ù„Ø¹Ù…ÙˆØ¯ K (Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯) -->
          <div class="filter-group">
            <label for="filterStatus">ğŸ§¾ Ø§Ù„Ø­Ø§Ù„Ø©:</label>
            <select id="filterStatus">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="Ù…Ù†ØªÙ‡ÙŠ">Ù…Ù†ØªÙ‡ÙŠ</option>
              <option value="Ø³Ø§Ø±ÙŠ">Ø³Ø§Ø±ÙŠ</option>
            </select>
          </div>
        </div>

        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</h2>
        <div id="locationsList"></div>

        <div class="legend">
          <h3>ğŸ” Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>
          <div style="font-size:12px;color:#666;line-height:1.6;">
            <p style="margin:8px 0;"><strong>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙˆÙ‚Ø¹</strong> Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
            <p style="margin:8px 0;"><strong>Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³</strong> Ù„Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ±</p>
            <p style="margin:8px 0;"><strong>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</strong> Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</p>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <span>Ø·ÙˆØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø´Ø±ÙƒØ© Ù…Ø²ÙŠØ¬ Ù„Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</span>
      <a href="https://mazeej.com.sa/" target="_blank" rel="noreferrer">
        <img src="mazeej-logo.png" alt="Ø´Ø¹Ø§Ø± Ù…Ø²ÙŠØ¬">
      </a>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

  <script>
    let map = null;
    let allSites = [];
    let markers = [];
    let currentFilters = { source: '', building: '', status: '' };

    function initMap() {
      map = L.map('map').setView([18.2164, 42.5053], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      setTimeout(() => { if (map) map.invalidateSize(); }, 250);
    }

    // âœ… Ù‚Ø±Ø§Ø¡Ø© Ù‚ÙŠÙ…Ø© Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø£Ø¹Ù…Ø¯Ø© Ù…ØªØ¹Ø¯Ø¯Ø© (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø£ÙŠ ØªØºÙŠÙ‘Ø± Ø¨Ø³ÙŠØ·)
    function getValue(details, keys) {
      if (!details) return '';
      for (const k of keys) {
        const v = (details[k] ?? '').toString().trim();
        if (v !== '') return v;
      }
      return '';
    }

    function normalizeFileNo(raw) {
      const s = (raw ?? '').toString().trim();
      if (!s) return '';
      const n = parseInt(s, 10);
      return Number.isFinite(n) ? String(n).padStart(3, '0') : s;
    }

    // âœ… ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©: 16,500.00
    function formatCurrency(value) {
      if (value === null || value === undefined) return '';
      const s = value.toString().trim();
      if (s === '') return '';
      const num = Number(s.replace(/,/g, ''));
      if (!Number.isFinite(num)) return s;
      return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // ğŸ”´ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ù…Ø±Ø§Ø¡ Ù„Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© (Ø§Ù„Ø³Ø§Ø±ÙŠ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
    const redIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // âœ… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯ (Unique): Ø³Ø§Ø±ÙŠ/Ù…Ù†ØªÙ‡ÙŠ + Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ
    function updateContractStats(sites) {
      const statusByContract = new Map(); // contractId -> status

      sites.forEach(site => {
        const d = site.details || {};
        const contractId = normalizeFileNo(getValue(d, ['Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø®Ø§Øµ Ù…Ø²ÙŠØ¬', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯']));
        if (!contractId || contractId === '000') return;

        const status = getValue(d, ['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯']); // K
        if (!statusByContract.has(contractId) && status) {
          statusByContract.set(contractId, status);
        }
      });

      let active = 0;
      let ended = 0;
      statusByContract.forEach(status => {
        if (status === 'Ø³Ø§Ø±ÙŠ') active++;
        else if (status === 'Ù…Ù†ØªÙ‡ÙŠ') ended++;
      });

      document.getElementById('totalContracts').textContent = statusByContract.size;
      document.getElementById('totalActive').textContent = active;
      document.getElementById('totalEnded').textContent = ended;

      // âœ… Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ = ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø­ØªÙ‰ Ø¨Ø¯ÙˆÙ† Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
      document.getElementById('totalLocations').textContent = sites.length;
    }

    // âœ… ÙÙ„Ø§ØªØ± Ø­Ø³Ø¨: O (Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±) Ùˆ P (Ø§Ù„Ù…Ø¨Ù†Ù‰)
    function populateFilters(sites) {
      const sources = new Set();
      const buildings = new Set();

      sites.forEach(site => {
        const d = site.details || {};
        const src = getValue(d, ['Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±']); // O
        const bld = getValue(d, ['Ø§Ù„Ù…Ø¨Ù†Ù‰']);           // P
        if (src) sources.add(src);
        if (bld) buildings.add(bld);
      });

      const sourceSelect = document.getElementById('filterSource');
      sourceSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option>';
      Array.from(sources).sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sourceSelect.appendChild(opt);
      });

      const buildingSelect = document.getElementById('filterBuilding');
      buildingSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>';
      Array.from(buildings).sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        buildingSelect.appendChild(opt);
      });

      sourceSelect.addEventListener('change', (e) => {
        currentFilters.source = e.target.value;
        updateBuildingFilter();
        filterAndDisplaySites();
      });

      buildingSelect.addEventListener('change', (e) => {
        currentFilters.building = e.target.value;
        filterAndDisplaySites();
      });

      document.getElementById('filterStatus').addEventListener('change', (e) => {
        currentFilters.status = e.target.value;
        filterAndDisplaySites();
      });
    }

    function updateBuildingFilter() {
      const buildingSelect = document.getElementById('filterBuilding');
      const currentBuilding = buildingSelect.value;

      let filtered = allSites;
      if (currentFilters.source) {
        filtered = allSites.filter(site => {
          const d = site.details || {};
          return getValue(d, ['Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±']) === currentFilters.source; // O
        });
      }

      const buildings = new Set();
      filtered.forEach(site => {
        const d = site.details || {};
        const b = getValue(d, ['Ø§Ù„Ù…Ø¨Ù†Ù‰']); // P
        if (b) buildings.add(b);
      });

      buildingSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>';
      Array.from(buildings).sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        buildingSelect.appendChild(opt);
      });

      if (buildings.has(currentBuilding)) buildingSelect.value = currentBuilding;
      else currentFilters.building = '';
    }

    function filterSites(sites) {
      return sites.filter(site => {
        const d = site.details || {};
        const src = getValue(d, ['Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±']); // O
        const bld = getValue(d, ['Ø§Ù„Ù…Ø¨Ù†Ù‰']);           // P
        const st  = getValue(d, ['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯']);       // K

        if (currentFilters.source && src !== currentFilters.source) return false;
        if (currentFilters.building && bld !== currentFilters.building) return false;
        if (currentFilters.status && st !== currentFilters.status) return false;
        return true;
      });
    }

    function filterAndDisplaySites() {
      displaySites(filterSites(allSites));
    }

    // âœ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ + Ø¥Ø®ÙØ§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ø¯ÙˆÙ† Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    function displaySites(sites) {
      if (!map) initMap();

      markers.forEach(m => map.removeLayer(m));
      markers = [];
      const list = document.getElementById('locationsList');
      list.innerHTML = '';

      // âœ… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      updateContractStats(sites);

      if (!sites || sites.length === 0) {
        list.innerHTML = '<div class="no-results">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</div>';
        return;
      }

      sites.forEach((location) => {
        const d = location.details || {};
        const lat = (location.lat !== null && location.lat !== undefined && String(location.lat).trim() !== '') ? parseFloat(location.lat) : NaN;
        const lon = (location.lon !== null && location.lon !== undefined && String(location.lon).trim() !== '') ? parseFloat(location.lon) : NaN;
        const validCoords = Number.isFinite(lat) && Number.isFinite(lon);

        const activity = getValue(d, ['Ø§Ù„Ù†Ø´Ø§Ø·']) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

        const siteVal     = getValue(d, ['Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±']); // O
        const buildingVal = getValue(d, ['Ø§Ù„Ù…Ø¨Ù†Ù‰']);            // P
        const investorVal = getValue(d, ['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±', 'Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±']);
        const rentVal     = formatCurrency(getValue(d, ['Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©']));
        const statusVal   = getValue(d, ['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯']);        // K

        // ===== Marker + Popup (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙÙŠÙ‡ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª) =====
        if (validCoords) {
          let popup = `<div style="direction: rtl; text-align: right; font-family: Tahoma, Arial, sans-serif;">`;
          popup += `<h4>${activity}</h4>`;

          // âœ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø§Ù„Ù€ Popup Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ
          popup += `<p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${siteVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
          popup += `<p><strong>Ø§Ù„Ù…Ø¨Ù†Ù‰:</strong> ${buildingVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
          popup += `<p><strong>Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±:</strong> ${investorVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
          popup += `<p><strong>Ø§Ù„Ø£Ø¬Ø±Ø©:</strong> ${rentVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
          popup += `<p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${statusVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
          popup += `<p><strong>Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}</p>`;
          popup += `</div>`;

          const marker = L.marker(
            [lat, lon],
            statusVal === 'Ù…Ù†ØªÙ‡ÙŠ' ? { icon: redIcon } : {}
          ).addTo(map).bindPopup(popup);

          markers.push(marker);
        }

        // âœ… Ø´Ø±Ø·Ùƒ: Ù„Ø§ Ù†Ø¶ÙŠÙ Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø°Ø§ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©
        if (!validCoords) return;

        // ===== Sidebar card (Desktop) =====
        const item = document.createElement('div');
        item.className = 'location-item';

        let html = `<h3>${activity}</h3>`;
        // âœ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ
        html += `<p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${siteVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
        html += `<p><strong>Ø§Ù„Ù…Ø¨Ù†Ù‰:</strong> ${buildingVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
        html += `<p><strong>Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±:</strong> ${investorVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
        html += `<p><strong>Ø§Ù„Ø£Ø¬Ø±Ø©:</strong> ${rentVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
        html += `<p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${statusVal || '<em style="color:#999;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em>'}</p>`;
        html += `<p><strong>Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}</p>`;

        item.innerHTML = html;

        item.addEventListener('click', () => {
          map.setView([lat, lon], 15);
          // Ø§ÙØªØ­ Ù†ÙØ³ Ø§Ù„Ù…Ø§Ø±ÙƒØ±
          const m = markers.find(mm => {
            const p = mm.getLatLng();
            return Math.abs(p.lat - lat) < 0.0001 && Math.abs(p.lng - lon) < 0.0001;
          });
          if (m) setTimeout(() => m.openPopup(), 200);
        });

        list.appendChild(item);
      });

      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }

      setTimeout(() => { if (map) map.invalidateSize(); }, 200);
    }

    // âœ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ø±ÙØ¹: ÙŠÙ‚Ø±Ø£ sites.json
    function loadData() {
      fetch('sites.json', { cache: 'no-store' })
        .then(res => {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        })
        .then(sites => {
          if (!sites || !sites.length) throw new Error('Empty data');

          document.getElementById('map').style.display = 'block';
          document.getElementById('emptyState').style.display = 'none';

          if (!map) initMap();
          allSites = sites;

          populateFilters(allSites);
          displaySites(allSites);
        })
        .catch(err => {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
          document.getElementById('emptyState').style.display = 'flex';
          document.getElementById('map').style.display = 'none';
        });
    }

    window.addEventListener('load', loadData);
    window.addEventListener('pageshow', loadData);
    window.addEventListener('resize', () => { if (map) map.invalidateSize(); });
  </script>
</body>
</html>
